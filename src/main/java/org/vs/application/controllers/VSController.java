package org.vs.application.controllers;


import com.google.gson.Gson;
import org.apache.commons.exec.OS;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.vs.application.CVEFinder;
import org.vs.application.model.CVEResult;
import org.vs.application.services.interfaces.SoftwareFinderService;
import org.vs.cvedetails.invoker.JSON;
import org.vs.application.services.VsCVEFinder;

import java.io.IOException;

@RestController
@RequestMapping("/api/vs")
public class VSController {
    private static final Gson gson = JSON.createGson().setLenient().create();

    @Autowired
    CVEFinder cveFinder;

    @Autowired
    SoftwareFinderService softwareFinderService;
    @GetMapping("/findlocal")
    public String findLocalSoftwares() {
        if (cveFinder !=null && OS.isFamilyWindows()){
            //List<CVEResult> results = cveFinder.findAllJsonCve();
            try {
                JSON.setGson(gson);
                System.out.println("request received!");
                return JSON.serialize(softwareFinderService.findInstalledSoftware());
            } catch (IOException | InterruptedException e) {
                throw new RuntimeException(e);
            }
        }else{
            //TODO: use unix one here
            cveFinder = new VsCVEFinder();
        }
        System.out.println("sending failure message");
        return "{ \"error\": \"Unknown Error\"";
    }

    @GetMapping("/cvecheck")
    public CVEResult fetchCVEDetails(@RequestParam String name,@RequestParam String version,@RequestParam String vendor){
        System.out.println("trying to find CVE related to name: " + name + ", version: " + version + ", vendor: " + vendor);
        return cveFinder.findListedCVE(name,version,vendor);
    }
    /*@PostMapping
    public String createUser(@RequestBody String user) {
        users.add(user);
        return "User created: " + user;
    }
    @DeleteMapping("/{user}")
    public String deleteUser(@PathVariable String user) {
        if (users.contains(user)) {
            users.remove(user);
            return "User deleted: " + user;
        }
        return "User not found";
    }*/
}
